#!/bin/bash

# ====================================
# Remote Approval Setup Tool
# ====================================
# Claude Codeの承認をiPhone/Apple Watchから行うための
# セットアップスクリプト
#
# 使い方:
#   ./setup check     - 現在の設定状態を確認
#   ./setup mac       - Macの設定を行う
#   ./setup tailscale - Tailscaleをインストール・設定
#   ./setup all       - 全ての設定を一括で行う
# ====================================

# 色付け
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ヘルプ表示
show_help() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  Remote Approval Setup Tool${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Claude Codeの承認をiPhone/Apple Watchから行うためのセットアップ"
    echo ""
    echo -e "${YELLOW}使い方:${NC}"
    echo "  ./setup check     現在の設定状態を確認"
    echo "  ./setup mac       Macの設定（リモートログイン有効化）"
    echo "  ./setup tailscale Tailscaleのインストール・設定"
    echo "  ./setup all       全ての設定を一括で行う"
    echo ""
    echo -e "${YELLOW}セットアップ後に必要なもの:${NC}"
    echo "  1. iPhoneに「Termius」アプリをインストール"
    echo "  2. iPhoneに「Tailscale」アプリをインストール"
    echo "  3. 同じTailscaleアカウントでログイン"
    echo ""
}

# 状態チェック
check_status() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  設定状態チェック${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # 1. リモートログイン
    echo -e "${BLUE}[1] リモートログイン (SSH)${NC}"
    if systemsetup -getremotelogin 2>/dev/null | grep -q "On"; then
        echo -e "    ${GREEN}✓ 有効${NC}"
    else
        echo -e "    ${RED}✗ 無効${NC}"
        echo "    → ./setup mac で有効化できます"
    fi
    echo ""

    # 2. Homebrew
    echo -e "${BLUE}[2] Homebrew${NC}"
    if command -v brew &> /dev/null; then
        echo -e "    ${GREEN}✓ インストール済み${NC}"
    else
        echo -e "    ${RED}✗ 未インストール${NC}"
        echo "    → ./setup mac でインストールできます"
    fi
    echo ""

    # 3. Tailscale
    echo -e "${BLUE}[3] Tailscale${NC}"
    if command -v tailscale &> /dev/null; then
        echo -e "    ${GREEN}✓ インストール済み${NC}"
        # 接続状態
        if tailscale status &> /dev/null; then
            echo -e "    ${GREEN}✓ 接続中${NC}"
            local ip=$(tailscale ip -4 2>/dev/null)
            if [ -n "$ip" ]; then
                echo -e "    TailscaleのIP: ${CYAN}$ip${NC}"
            fi
        else
            echo -e "    ${YELLOW}△ 未接続${NC}"
            echo "    → tailscale up でログインしてください"
        fi
    else
        echo -e "    ${RED}✗ 未インストール${NC}"
        echo "    → ./setup tailscale でインストールできます"
    fi
    echo ""

    # 4. ローカルIPアドレス
    echo -e "${BLUE}[4] ローカルIPアドレス${NC}"
    local local_ip=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null)
    if [ -n "$local_ip" ]; then
        echo -e "    WiFi: ${CYAN}$local_ip${NC}"
    else
        echo -e "    ${YELLOW}△ WiFi未接続${NC}"
    fi
    echo ""

    # 5. ユーザー名
    echo -e "${BLUE}[5] 接続情報${NC}"
    echo -e "    ユーザー名: ${CYAN}$(whoami)${NC}"
    echo -e "    ホスト名: ${CYAN}$(hostname)${NC}"
    echo ""
}

# Mac設定
setup_mac() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  Macの設定${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # 1. リモートログイン有効化
    echo -e "${BLUE}[1] リモートログインの有効化${NC}"
    if systemsetup -getremotelogin 2>/dev/null | grep -q "On"; then
        echo -e "    ${GREEN}✓ 既に有効です${NC}"
    else
        echo "    リモートログインを有効にします..."
        echo -e "    ${YELLOW}※ 管理者パスワードが必要です${NC}"
        sudo systemsetup -setremotelogin on
        if [ $? -eq 0 ]; then
            echo -e "    ${GREEN}✓ 有効化しました${NC}"
        else
            echo -e "    ${RED}✗ 有効化に失敗しました${NC}"
            echo ""
            echo "    手動で設定する場合:"
            echo "    システム設定 → 一般 → 共有 → リモートログイン をON"
        fi
    fi
    echo ""

    # 2. Homebrew
    echo -e "${BLUE}[2] Homebrewの確認${NC}"
    if ! command -v brew &> /dev/null; then
        echo "    Homebrewをインストールします..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo -e "    ${GREEN}✓ インストール完了${NC}"
    else
        echo -e "    ${GREEN}✓ 既にインストール済み${NC}"
    fi
    echo ""

    echo -e "${GREEN}Mac設定完了${NC}"
}

# Tailscaleセットアップ
setup_tailscale() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  Tailscaleのセットアップ${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Homebrewチェック
    if ! command -v brew &> /dev/null; then
        echo -e "${RED}エラー: Homebrewがインストールされていません${NC}"
        echo "先に ./setup mac を実行してください"
        exit 1
    fi

    # 1. Tailscaleインストール
    echo -e "${BLUE}[1] Tailscaleのインストール${NC}"
    if command -v tailscale &> /dev/null; then
        echo -e "    ${GREEN}✓ 既にインストール済み${NC}"
    else
        echo "    Tailscaleをインストールします..."
        brew install --cask tailscale
        echo -e "    ${GREEN}✓ インストール完了${NC}"
    fi
    echo ""

    # 2. Tailscale起動
    echo -e "${BLUE}[2] Tailscaleの起動${NC}"
    if ! pgrep -x "Tailscale" > /dev/null; then
        echo "    Tailscaleを起動します..."
        open -a Tailscale
        sleep 3
    fi
    echo -e "    ${GREEN}✓ 起動中${NC}"
    echo ""

    # 3. ログイン案内
    echo -e "${BLUE}[3] ログイン${NC}"
    if tailscale status &> /dev/null; then
        echo -e "    ${GREEN}✓ ログイン済み${NC}"
        local ip=$(tailscale ip -4 2>/dev/null)
        echo -e "    TailscaleのIP: ${CYAN}$ip${NC}"
    else
        echo -e "    ${YELLOW}ログインが必要です${NC}"
        echo ""
        echo "    以下のコマンドでログインしてください:"
        echo -e "    ${CYAN}tailscale up${NC}"
        echo ""
        echo "    または、メニューバーのTailscaleアイコンから"
        echo "    「Log in...」をクリックしてください"
    fi
    echo ""

    echo -e "${GREEN}Tailscaleセットアップ完了${NC}"
    echo ""
    echo -e "${YELLOW}次のステップ:${NC}"
    echo "  1. iPhoneでApp Storeから「Tailscale」をインストール"
    echo "  2. 同じアカウントでログイン"
    echo "  3. iPhoneでApp Storeから「Termius」をインストール"
    echo "  4. README.mdの手順に従って接続設定"
    echo ""
}

# 全セットアップ
setup_all() {
    setup_mac
    setup_tailscale
    echo ""
    check_status
}

# メイン処理
case "$1" in
    check)
        check_status
        ;;
    mac)
        setup_mac
        ;;
    tailscale)
        setup_tailscale
        ;;
    all)
        setup_all
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        ;;
esac
