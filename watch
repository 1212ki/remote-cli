#!/bin/bash
# ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - é›¢å¸­æ™‚ã«Slacké€šçŸ¥ã‚’é€ã‚‹ï¼ˆè¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
# ä½¿ã„æ–¹: ./watch start | ./watch stop | ./watch status

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LOG_DIR="/tmp/claude-watch"

# Slacké€šçŸ¥ã¯ `SLACK_WEBHOOK_URL` ã§æœ‰åŠ¹åŒ–ã™ã‚‹ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã«Webhookã‚’åŸ‹ã‚è¾¼ã¾ãªã„ï¼‰
# - ç’°å¢ƒå¤‰æ•°: export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
# - .env: tools/remote-approval/.env ã« SLACK_WEBHOOK_URL=... ã‚’ç½®ãï¼ˆbashã§sourceå¯èƒ½ãªå½¢å¼ï¼‰
SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"
if [[ -z "$SLACK_WEBHOOK_URL" && -f "$SCRIPT_DIR/.env" ]]; then
    set -a
    # shellcheck disable=SC1091
    source "$SCRIPT_DIR/.env"
    set +a
    SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"
fi

# è‰²ä»˜ãå‡ºåŠ›
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

mkdir -p "$LOG_DIR"

send_slack() {
    local message="$1"
    local emoji="${2:-ğŸ‘€}"
    [[ -n "$SLACK_WEBHOOK_URL" ]] || return 0
    curl -s -X POST "$SLACK_WEBHOOK_URL" \
        -H 'Content-type: application/json' \
        -d "{\"text\": \"${emoji} ${message}\"}" > /dev/null 2>&1 || true
}

# å…¨ã¦ã®claude/codexã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œå‡º
detect_all_sessions() {
    tmux ls -F '#S' 2>/dev/null \
        | grep -E '^(claude|codex)([0-9]+)?$' \
        | sort -V || true
}

start_watch() {
    # æ—¢ã«ç›£è¦–ä¸­ãªã‚‰åœæ­¢
    if [[ -f "$LOG_DIR/watch.pid" ]]; then
        stop_watch quiet
    fi

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡º
    local sessions
    sessions=($(detect_all_sessions))

    if [[ ${#sessions[@]} -eq 0 ]]; then
        echo -e "${RED}ã‚¨ãƒ©ãƒ¼: ç›£è¦–å¯¾è±¡ã®tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
        echo "tc ã¾ãŸã¯ tcodex ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ãã ã•ã„"
        exit 1
    fi

    echo -e "${GREEN}ç›£è¦–é–‹å§‹: ${#sessions[@]}å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³${NC}"
    for s in "${sessions[@]}"; do
        echo "  - $s"
    done

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³åã‚’ä¿å­˜
    echo "${sessions[*]}" > "$LOG_DIR/session_names"

    # ãƒ¡ã‚¤ãƒ³PIDãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç›£è¦–ä¸­ãƒ•ãƒ©ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼‰
    echo $$ > "$LOG_DIR/watch.pid"

    # å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ç›£è¦–ã‚’é–‹å§‹
    for session in "${sessions[@]}"; do
        local log_file="$LOG_DIR/session_${session}.log"
        local pid_file="$LOG_DIR/watch_${session}.pid"

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–
        : > "$log_file"

        # tmux pipe-pane ã§ãƒ­ã‚°å‡ºåŠ›é–‹å§‹
        tmux pipe-pane -t "$session" -o "cat >> $log_file"

        # ç›£è¦–ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
        nohup bash -c '
            SLACK_WEBHOOK_URL="'"$SLACK_WEBHOOK_URL"'"
            LOG_FILE="'"$log_file"'"
            LOG_DIR="'"$LOG_DIR"'"
            SESSION_NAME="'"$session"'"

            send_slack_bg() {
                local message="$1"
                local emoji="${2:-ğŸ‘€}"
                [[ -n "$SLACK_WEBHOOK_URL" ]] || return 0
                curl -s -X POST "$SLACK_WEBHOOK_URL" \
                    -H "Content-type: application/json" \
                    -d "{\"text\": \"${emoji} ${message}\"}" > /dev/null 2>&1 || true
            }

            # ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’é™¤å»ã™ã‚‹é–¢æ•°
            strip_ansi() {
                sed "s/\x1b\[[0-9;]*[a-zA-Z]//g" | sed "s/\x1b\][^]*\x07//g" | tr -d "\r"
            }

            echo $$ > "'"$pid_file"'"
            last_notify_error=0
            input_flag="$LOG_DIR/input_${SESSION_NAME}"

            # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–
            tail -n 0 -f "$LOG_FILE" 2>/dev/null | while read -r line; do
                now=$(date +%s)
                # ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’é™¤å»
                clean_line=$(echo "$line" | strip_ansi)

                # æ‰¿èªå¾…ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º â†’ å³é€šçŸ¥ï¼ˆ5åˆ†é–“éš”ã€å…¥åŠ›å¾…ã¡ã¨å…±é€šãƒ•ãƒ©ã‚°ï¼‰
                if echo "$clean_line" | grep -qE "(Allow (once|always)|è¨±å¯ã—ã¾ã™ã‹|y/n\]|\[y/N\]|\(yes/no\)|Do you want to)"; then
                    last_notify=0
                    [[ -f "$input_flag" ]] && last_notify=$(cat "$input_flag" 2>/dev/null || echo 0)
                    if (( now - last_notify >= 300 )); then
                        send_slack_bg "ã€å…¥åŠ›å¾…ã¡ã€‘[$SESSION_NAME] æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™" "â³"
                        echo "$now" > "$input_flag"
                    fi
                fi

                # ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºï¼ˆ5åˆ†é–“éš”ï¼‰
                if echo "$clean_line" | grep -qE "(^Error:|^error:|: Error:|: error:|^ã‚¨ãƒ©ãƒ¼:|ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ| failed$| Failed$|FAILED:)"; then
                    if (( now - last_notify_error > 300 )); then
                        send_slack_bg "ã€ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã€‘[$SESSION_NAME] ç¢ºèªãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“" "âš ï¸"
                        last_notify_error=$now
                    fi
                fi
            done
        ' > /dev/null 2>&1 &
    done

    # ã‚¢ã‚¤ãƒ‰ãƒ«ãƒ»å…¥åŠ›å¾…ã¡æ¤œå‡ºç”¨ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆå…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±é€šã§1ã¤ï¼‰
    nohup bash -c '
        SLACK_WEBHOOK_URL="'"$SLACK_WEBHOOK_URL"'"
        LOG_DIR="'"$LOG_DIR"'"

        send_slack_bg() {
            local message="$1"
            local emoji="${2:-ğŸ‘€}"
            [[ -n "$SLACK_WEBHOOK_URL" ]] || return 0
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
                -H "Content-type: application/json" \
                -d "{\"text\": \"${emoji} ${message}\"}" > /dev/null 2>&1 || true
        }

        sleep 5
        while [[ -f "$LOG_DIR/watch.pid" ]]; do
            sleep 30

            # å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å…¥åŠ›å¾…ã¡æ¤œå‡ºï¼ˆãƒ­ã‚°ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚‰ãªã‘ã‚Œã°å…¥åŠ›å¾…ã¡ï¼‰
            now=$(date +%s)
            for log_file in "$LOG_DIR"/session_*.log; do
                [[ -f "$log_file" ]] || continue
                session_name=$(basename "$log_file" | sed "s/session_//;s/.log//")

                current_size=$(stat -f %z "$log_file" 2>/dev/null || echo 0)
                size_file="$LOG_DIR/size_${session_name}"
                input_flag="$LOG_DIR/input_${session_name}"

                # å‰å›ã‚µã‚¤ã‚ºã‚’å–å¾—
                prev_size=0
                [[ -f "$size_file" ]] && prev_size=$(cat "$size_file" 2>/dev/null || echo 0)

                # ç¾åœ¨ã‚µã‚¤ã‚ºã‚’ä¿å­˜
                echo "$current_size" > "$size_file"

                start_flag="$LOG_DIR/start_${session_name}"
                notify_flag="$LOG_DIR/notify_${session_name}"

                if [[ "$current_size" == "$prev_size" ]] && (( prev_size > 0 )); then
                    # ã‚µã‚¤ã‚ºå¤‰ã‚ã‚‰ãš = å…¥åŠ›å¾…ã¡
                    # é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆã¾ã ãªã‘ã‚Œã°ï¼‰
                    [[ ! -f "$start_flag" ]] && echo "$now" > "$start_flag"

                    # 5åˆ†é–“éš”ã§å†é€šçŸ¥
                    last_notify=0
                    [[ -f "$notify_flag" ]] && last_notify=$(cat "$notify_flag" 2>/dev/null || echo 0)
                    if (( now - last_notify >= 300 )); then
                        send_slack_bg "ã€å…¥åŠ›å¾…ã¡ã€‘[$session_name] æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™" "â³"
                        echo "$now" > "$notify_flag"
                    fi
                else
                    # ã‚µã‚¤ã‚ºå¤‰ã‚ã£ãŸ = ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                    rm -f "$start_flag" "$notify_flag"
                fi
            done

            # å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¤ãƒ‰ãƒ«æ¤œå‡ºï¼ˆå…¥åŠ›å¾…ã¡ãŒ15åˆ†ä»¥ä¸Šç¶šã„ã¦ã„ã‚‹ï¼‰
            all_idle=true
            idle_sessions=""
            for log_file in "$LOG_DIR"/session_*.log; do
                [[ -f "$log_file" ]] || continue
                session_name=$(basename "$log_file" | sed "s/session_//;s/.log//")
                start_flag="$LOG_DIR/start_${session_name}"

                if [[ -f "$start_flag" ]]; then
                    # å…¥åŠ›å¾…ã¡é–‹å§‹æ™‚åˆ»ã‚’ç¢ºèª
                    start_time=$(cat "$start_flag" 2>/dev/null || echo "$now")
                    if (( now - start_time >= 900 )); then
                        idle_sessions="$idle_sessions $session_name"
                    else
                        all_idle=false
                    fi
                else
                    # é–‹å§‹ãƒ•ãƒ©ã‚°ãŒãªã„ = ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                    all_idle=false
                fi
            done

            idle_flag="$LOG_DIR/idle_notified"
            if $all_idle && [[ -n "$idle_sessions" ]] && [[ ! -f "$idle_flag" ]]; then
                send_slack_bg "ã€ä½œæ¥­å®Œäº†ï¼Ÿã€‘å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ15åˆ†ä»¥ä¸Šåœæ­¢ä¸­" "âœ…"
                touch "$idle_flag"
            elif ! $all_idle; then
                rm -f "$idle_flag"
            fi
        done
    ' > /dev/null 2>&1 &

    send_slack "ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ (${#sessions[@]}ã‚»ãƒƒã‚·ãƒ§ãƒ³: ${sessions[*]})" "ğŸ“±"
    send_slack "ğŸ’¡ PCã®Tailscale VPNã«æ¥ç¶šã—ã¾ã—ãŸã‹ï¼Ÿ" "ğŸ“²"
    echo -e "${GREEN}Slacké€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ${NC}"
    echo -e "${YELLOW}ğŸ’¡ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼: PCã®Tailscale VPNã«æ¥ç¶šã—ã¾ã—ãŸã‹ï¼Ÿ${NC}"
    echo "åœæ­¢ã™ã‚‹ã«ã¯: ./watch stop ã¾ãŸã¯ã€Œç›£è¦–çµ‚äº†ã€ã¨ä¼ãˆã¦ãã ã•ã„"
}

stop_watch() {
    local quiet="${1:-}"

    if [[ -f "$LOG_DIR/watch.pid" ]]; then
        # å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç›£è¦–ã‚’åœæ­¢
        for pid_file in "$LOG_DIR"/watch_*.pid; do
            [[ -f "$pid_file" ]] || continue
            local pid
            pid=$(cat "$pid_file")
            pkill -P "$pid" 2>/dev/null || true
            kill "$pid" 2>/dev/null || true
            rm -f "$pid_file"
        done

        # ã‚»ãƒƒã‚·ãƒ§ãƒ³åã‚’èª­ã¿è¾¼ã‚“ã§pipe-paneã‚’åœæ­¢
        if [[ -f "$LOG_DIR/session_names" ]]; then
            for session in $(cat "$LOG_DIR/session_names"); do
                tmux pipe-pane -t "$session" 2>/dev/null || true
            done
        fi

        # é–¢é€£ãƒ—ãƒ­ã‚»ã‚¹ã‚‚åœæ­¢
        pkill -f "tail -n 0 -f $LOG_DIR/session_" 2>/dev/null || true

        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -f "$LOG_DIR/watch.pid" "$LOG_DIR/idle_notified" "$LOG_DIR/session_names"
        rm -f "$LOG_DIR"/session_*.log "$LOG_DIR"/watch_*.pid
        rm -f "$LOG_DIR"/start_* "$LOG_DIR"/notify_* "$LOG_DIR"/size_*

        if [[ "$quiet" != "quiet" ]]; then
            send_slack "ç›£è¦–ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ã—ã¾ã—ãŸ" "ğŸ‘‹"
            echo -e "${GREEN}ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ${NC}"
        fi
    else
        if [[ "$quiet" != "quiet" ]]; then
            echo -e "${YELLOW}ç›£è¦–ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
        fi
    fi
}

status_watch() {
    if [[ -f "$LOG_DIR/watch.pid" ]]; then
        echo -e "${GREEN}ç›£è¦–ä¸­${NC}"
        if [[ -f "$LOG_DIR/session_names" ]]; then
            echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³:"
            for session in $(cat "$LOG_DIR/session_names"); do
                echo "  - $session"
            done
        fi
    else
        echo -e "${YELLOW}ç›£è¦–åœæ­¢ä¸­${NC}"
    fi
}

case "${1:-}" in
    start)
        start_watch
        ;;
    stop)
        stop_watch
        ;;
    status)
        status_watch
        ;;
    *)
        echo "ä½¿ã„æ–¹: $0 {start|stop|status}"
        echo ""
        echo "  start   å…¨ã¦ã®claude/codexã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç›£è¦–ã‚’é–‹å§‹"
        echo "  stop    ç›£è¦–åœæ­¢"
        echo "  status  ç›£è¦–çŠ¶æ…‹ã‚’ç¢ºèª"
        exit 1
        ;;
esac
